name: Deploy Back to EKS

on:
  workflow_dispatch:
  push:
    branches: ["main"]

permissions:
  id-token: write
  contents: read

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Configurar JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: maven

      - name: Build projeto e gerar JAR
        run: mvn clean package -DskipTests=true

      - name: Login no Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build e Push da imagem
        run: |
          IMAGE=nicolasmartinss/customer-service:${{ github.sha }}
          docker build -t $IMAGE -f docker/Dockerfile .
          docker push $IMAGE
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV

      - name: Configurar AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: us-east-1
          role-to-assume: arn:aws:iam::601920909369:role/aws-actions

      - name: Update kubeconfig
        run: aws eks update-kubeconfig --name tech-challenge-cluster --region us-east-1

      - name: Garantir namespace techchallenge
        run: |
          kubectl get namespace techchallenge || kubectl create namespace techchallenge

      - name: Criar/atualizar Secret do banco
        run: |
          kubectl create secret generic customer-service-secret \
            --namespace techchallenge \
            --from-literal=MONGODB_URI="${{ secrets.MONGODB_URI }}" \
            --from-literal=JWT_SECRET="${{ secrets.JWT_SECRET }}" \
            --dry-run=client -o yaml | kubectl apply -f -

      - name: Atualizar Deployment com nova imagem
        run: |
          sed -i "s|image: nicolasmartinss/customer-service:.*|image: $IMAGE|" infra/k8s/deployment.yaml
          kubectl apply -f infra/k8s/

      - name: Deploy to Kubernetes
        run: kubectl apply -f infra/k8s/

      - name: Aguardar rollout do Admin
        run: |
          kubectl rollout status deployment/tech-challenge-admin-service -n techchallenge --timeout=180s

      - name: Healthcheck interno (Admin)
        run: |
          kubectl run curl-test-admin --rm -i \
            --image=curlimages/curl \
            --restart=Never \
            -n techchallenge \
            -- curl -fsS http://tech-challenge-admin-service:8080/actuator/health